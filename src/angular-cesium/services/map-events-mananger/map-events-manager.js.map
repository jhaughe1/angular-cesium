{"version":3,"sources":["map-events-manager.ts"],"names":[],"mappings":"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","file":"map-events-manager.js","sourceRoot":"","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { Subject } from 'rxjs/Subject';\r\nimport { Observable } from 'rxjs/Observable';\r\nimport { CesiumService } from '../cesium/cesium.service';\r\nimport { CesiumEventBuilder } from './cesium-event-builder';\r\nimport { EventRegistrationInput } from './event-registration-input';\r\nimport { DisposableObservable } from './disposable-observable';\r\nimport { PickOptions } from './consts/pickOptions.enum';\r\nimport { CesiumEvent } from './consts/cesium-event.enum';\r\nimport { CesiumEventModifier } from './consts/cesium-event-modifier.enum';\r\nimport { PlonterService } from '../plonter/plonter.service';\r\nimport { UtilsService } from '../../utils/utils.service';\r\nimport { CesiumDragDropHelper } from './event-observers/cesium-drag-drop-helper';\r\n\r\nclass Registration {\r\n\tconstructor(public observable: Observable<EventResult>,\r\n\t\t\t\t\t\t\tpublic  stopper: Subject<any>,\r\n\t\t\t\t\t\t\tpublic  priority: number,\r\n\t\t\t\t\t\t\tpublic  isPaused: boolean) {\r\n\t}\r\n}\r\n\r\n/**\r\n * Returns screen position, drag boolean for drag events only\r\n */\r\nexport interface Movement {\r\n\tstartPosition: { x: number, y: number };\r\n\tendPosition: { x: number, y: number };\r\n\tdrop?: boolean;\r\n}\r\n\r\nexport interface EventResult {\r\n\tmovement: Movement;\r\n\tcesiumEntities: any[];\r\n\tentities: any[];\r\n}\r\n\r\n/**\r\n * Manages all map events. Notice events will run outside of Angular zone.\r\n * Provided by `<ac-map/>` component there for could be injected at any component under `<ac-map/>` hierarchy\r\n * or from the `<ac-map/>` component reference `acMapComponent.getMapEventsManager()`\r\n *\r\n * __usage:__\r\n * ```\r\n * MapEventsManagerService.register({event, modifier, priority, entityType, pickOption}).subscribe()\r\n * ```\r\n * __param:__ {CesiumEvent} event\r\n * __param:__ {CesiumEventModifier} modifier\r\n * __param:__ priority - the bigger the number the bigger the priority. default : 0.\r\n * __param:__ entityType - entity type class that you are interested like (Track). the class must extends AcEntity\r\n * __param:__ pickOption - self explained\r\n */\r\n\r\nexport class MapEventsManagerService {\r\n\t\r\n\tprivate scene: any;\r\n\tprivate eventRegistrations = new Map<string, Registration[]>();\r\n\t\r\n\tconstructor(private cesiumService: CesiumService,\r\n\t\t\t\t\t\t\tprivate eventBuilder: CesiumEventBuilder,\r\n\t\t\t\t\t\t\tprivate plonterService: PlonterService) {\r\n\t}\r\n\t\r\n\tinit() {\r\n\t\tthis.eventBuilder.init();\r\n\t\tthis.scene = this.cesiumService.getScene();\r\n\t}\r\n\t\r\n\t/**\r\n\t * Register to map event\r\n\t * @param input {EventRegistrationInput}\r\n\t *\r\n\t * @returns {DisposableObservable<EventResult>}\r\n\t */\r\n\tregister(input: EventRegistrationInput): DisposableObservable<EventResult> {\r\n\t\tif (this.scene === undefined) {\r\n\t\t\tthrow new Error('CesiumService has not been initialized yet - MapEventsManagerService must be injected  under ac-map');\r\n\t\t}\r\n\t\t\r\n\t\tinput.pick = input.pick || PickOptions.NO_PICK;\r\n\t\tinput.priority = input.priority || 0;\r\n\t\t\r\n\t\tif (input.entityType && input.pick === PickOptions.NO_PICK) {\r\n\t\t\tthrow new Error('MapEventsManagerService: can\\'t register an event ' +\r\n\t\t\t\t'with entityType and PickOptions.NO_PICK - It doesn\\'t make sense ');\r\n\t\t}\r\n\t\t\r\n\t\tconst eventName = CesiumEventBuilder.getEventFullName(input.event, input.modifier);\r\n\t\t\r\n\t\tif (!this.eventRegistrations.has(eventName)) {\r\n\t\t\tthis.eventRegistrations.set(eventName, []);\r\n\t\t}\r\n\t\t\r\n\t\tconst eventRegistration = this.createEventRegistration(input.event, input.modifier, input.entityType, input.pick, input.priority);\r\n\t\tconst registrationObservable: any = eventRegistration.observable;\r\n\t\tregistrationObservable.dispose = () => this.disposeObservable(eventRegistration, eventName);\r\n\t\tthis.eventRegistrations.get(eventName).push(eventRegistration);\r\n\t\t\r\n\t\tthis.sortRegistrationsByPriority(eventName);\r\n\t\treturn <DisposableObservable<EventResult>> registrationObservable;\r\n\t}\r\n\t\r\n\tprivate disposeObservable(eventRegistration: Registration, eventName: string) {\r\n\t\teventRegistration.stopper.next(1);\r\n\t\tconst registrations = this.eventRegistrations.get(eventName);\r\n\t\tconst index = registrations.indexOf(eventRegistration);\r\n\t\tif (index !== -1) {\r\n\t\t\tregistrations.splice(index, 1);\r\n\t\t}\r\n\t\tthis.sortRegistrationsByPriority(eventName);\r\n\t}\r\n\t\r\n\tprivate sortRegistrationsByPriority(eventName: string) {\r\n\t\tconst registrations = this.eventRegistrations.get(eventName);\r\n\t\tregistrations.sort((a, b) => b.priority - a.priority);\r\n\t\tif (registrations.length === 0) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\t// Active registrations by priority\r\n\t\tconst currentPriority = registrations[0].priority;\r\n\t\tregistrations.forEach((registration) => {\r\n\t\t\tregistration.isPaused = registration.priority < currentPriority;\r\n\t\t});\r\n\t\t\r\n\t}\r\n\t\r\n\tprivate createEventRegistration(event: CesiumEvent, modifier: CesiumEventModifier,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tentityType: any, pickOption: PickOptions, priority: number): Registration {\r\n\t\tconst cesiumEventObservable = this.eventBuilder.get(event, modifier);\r\n\t\tconst stopper = new Subject<any>();\r\n\t\t\r\n\t\tconst registration = new Registration(undefined, stopper, priority, false);\r\n\t\tlet observable: Observable<EventResult>;\r\n\t\t\r\n\t\tif (!CesiumDragDropHelper.dragEvents.has(event)) {\r\n\t\t\tobservable = cesiumEventObservable\r\n\t\t\t\t.filter(() => !registration.isPaused)\r\n\t\t\t\t.map((movement) => this.triggerPick(movement, pickOption))\r\n\t\t\t\t.filter((result) => result.cesiumEntities !== null || entityType === undefined)\r\n\t\t\t\t.map((picksAndMovement) => this.addEntities(picksAndMovement, entityType, pickOption))\r\n\t\t\t\t.filter((result) => result.entities !== null || entityType === undefined)\r\n\t\t\t\t.switchMap((entitiesAndMovement) => this.plonter(entitiesAndMovement, pickOption))\r\n\t\t\t\t.takeUntil(stopper);\r\n\t\t} else {\r\n\t\t\tobservable = this.createDragEvent(event, modifier, entityType, pickOption, priority).takeUntil(stopper);\r\n\t\t}\r\n\t\t\r\n\t\tregistration.observable = observable;\r\n\t\treturn registration;\r\n\t}\r\n\t\r\n\tprivate createDragEvent(event: CesiumEvent, modifier: CesiumEventModifier, entityType: any, pickOption: PickOptions,\r\n\t\t\t\t\t\t\tpriority: number): Observable<EventResult> {\r\n\t\tconst {mouseDownEvent, mouseUpEvent} = CesiumDragDropHelper.getDragEventTypes(event);\r\n\t\t\r\n\t\tconst mouseUpObservable = this.eventBuilder.get(mouseUpEvent);\r\n\t\tconst mouseMoveObservable = this.eventBuilder.get(CesiumEvent.MOUSE_MOVE);\r\n\t\t\r\n\t\tconst mouseDownRegistration = this.createEventRegistration(mouseDownEvent, modifier, entityType, pickOption,\r\n\t\t\tpriority);\r\n\t\t\r\n\t\tconst dropSubject = new Subject<EventResult>();\r\n\t\tconst dragObserver = mouseDownRegistration.observable.mergeMap(e => {\r\n\t\t\tlet lastMove: any = null;\r\n\t\t\tconst dragStartPositionX = e.movement.startPosition.x;\r\n\t\t\tconst dragStartPositionY = e.movement.startPosition.y;\r\n\t\t\treturn mouseMoveObservable.map((movement) => {\r\n\t\t\t\tlastMove = {\r\n\t\t\t\t\tmovement : {\r\n\t\t\t\t\t\tdrop : false,\r\n\t\t\t\t\t\tstartPosition : {\r\n\t\t\t\t\t\t\tx : dragStartPositionX,\r\n\t\t\t\t\t\t\ty : dragStartPositionY,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tendPosition : movement.endPosition,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tentities : e.entities,\r\n\t\t\t\t\tcesiumEntities : e.cesiumEntities\r\n\t\t\t\t};\r\n\t\t\t\treturn lastMove;\r\n\t\t\t}).takeUntil(mouseUpObservable).do(undefined, undefined, () => {\r\n\t\t\t\t// On complete\r\n\t\t\t\tif (lastMove) {\r\n\t\t\t\t\tconst dropEvent = Object.assign({}, lastMove);\r\n\t\t\t\t\tdropEvent.movement.drop = true;\r\n\t\t\t\t\tdropSubject.next(dropEvent);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\t\r\n\t\treturn dragObserver.merge(dropSubject);\r\n\t\t\r\n\t}\r\n\t\r\n\tprivate triggerPick(movement: any, pickOptions: PickOptions) {\r\n\t\tlet picks: any = [];\r\n\t\tswitch (pickOptions) {\r\n\t\t\tcase PickOptions.PICK_ONE:\r\n\t\t\tcase PickOptions.PICK_ALL:\r\n\t\t\t\tpicks = this.scene.drillPick(movement.endPosition);\r\n\t\t\t\tpicks = picks.length === 0 ? null : picks;\r\n\t\t\t\tbreak;\r\n\t\t\tcase PickOptions.PICK_FIRST:\r\n\t\t\t\tconst pick = this.scene.pick(movement.endPosition);\r\n\t\t\t\tpicks = pick === undefined ? null : [pick];\r\n\t\t\t\tbreak;\r\n\t\t\tcase PickOptions.NO_PICK:\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t\r\n\t\t// Picks can be cesium entity or cesium primitive\r\n\t\tif (picks) {\r\n\t\t\tpicks = picks.map((pick: any) => pick.id && pick.id instanceof Cesium.Entity ? pick.id : pick.primitive);\r\n\t\t}\r\n\t\t\r\n\t\treturn {movement : movement, cesiumEntities : picks};\r\n\t}\r\n\t\r\n\tprivate addEntities(picksAndMovement: any, entityType: any, pickOption: PickOptions): EventResult {\r\n\t\t\r\n\t\tif (picksAndMovement.cesiumEntities === null) {\r\n\t\t\tpicksAndMovement.entities = null;\r\n\t\t\treturn picksAndMovement;\r\n\t\t}\r\n\t\tlet entities = [];\r\n\t\tif (pickOption !== PickOptions.NO_PICK) {\r\n\t\t\tif (entityType) {\r\n\t\t\t\tentities = picksAndMovement.cesiumEntities.map((pick: any) => pick.acEntity).filter((acEntity: any) => {\r\n\t\t\t\t\treturn acEntity && acEntity instanceof entityType;\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tentities = picksAndMovement.cesiumEntities.map((pick: any) => pick.acEntity);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tentities = UtilsService.unique(entities);\r\n\t\t\tif (entities.length === 0) {\r\n\t\t\t\tentities = null;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tpicksAndMovement.entities = entities;\r\n\t\treturn picksAndMovement;\r\n\t}\r\n\t\r\n\tprivate plonter(entitiesAndMovement: EventResult, pickOption: PickOptions): Observable<EventResult> {\r\n\t\tif (pickOption === PickOptions.PICK_ONE && entitiesAndMovement.entities !== null && entitiesAndMovement.entities.length > 1) {\r\n\t\t\treturn this.plonterService.plonterIt(entitiesAndMovement);\r\n\t\t} else {\r\n\t\t\treturn Observable.of(entitiesAndMovement);\r\n\t\t}\r\n\t}\r\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: CesiumService, },\n{type: CesiumEventBuilder, },\n{type: PlonterService, },\n];\n}\r\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}