{"version":3,"sources":["ac-array-desc.component.ts"],"names":[],"mappings":"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","file":"ac-array-desc.component.js","sourceRoot":"","sourcesContent":["import {\r\n  AfterContentInit,\r\n  ChangeDetectorRef,\r\n  Component,\r\n  ContentChildren,\r\n  Input,\r\n  OnChanges,\r\n  OnDestroy,\r\n  OnInit,\r\n  SimpleChanges,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { AcNotification } from '../../models/ac-notification';\r\nimport { Subject } from 'rxjs/Subject';\r\nimport { IDescription } from '../../models/description';\r\nimport * as _get from 'lodash.get';\r\nimport { AcLayerComponent } from '../ac-layer/ac-layer.component';\r\nimport { LayerService } from '../../services/layer-service/layer-service.service';\r\nimport { BasicDesc } from '../../services/basic-desc/basic-desc.service';\r\nimport { Subscription } from 'rxjs/Subscription';\r\n\r\n/**\r\n *  This is component represents an array under `ac-layer`.\r\n *  The element must be a child of ac-layer element.\r\n *  + acFor `{string}` - get the tracked array and entityName (see the example).\r\n *  + idGetter `{Function}` - a function that gets the id for a given element in the array -should be defined for maximum performance.\r\n *  + show `{boolean}` - show/hide array's entities.\r\n *\r\n *  __Usage :__\r\n *  ```\r\n *<ac-layer acFor=\"let track of tracks$\" [show]=\"show\" [context]=\"this\" [store]=\"true\">\r\n *  <ac-array-desc acFor=\"let arrayItem of track.array\" [idGetter]=\"trackArrayIdGetter\">\r\n *    <ac-array-desc acFor=\"let innerArrayItem of arrayItem.innerArray\" [idGetter]=\"trackArrayIdGetter\">\r\n *      <ac-point-desc props=\"{\r\n *        position: innerArrayItem.pos,\r\n *        pixelSize: 10,\r\n *        color: getTrackColor(track),\r\n *        outlineColor: Cesium.Color.BLUE,\r\n *        outlineWidth: 1\r\n *      }\">\r\n *      </ac-point-desc>\r\n *    </ac-array-desc>\r\n *  </ac-array-desc>\r\n *</ac-layer>\r\n *  ```\r\n */\r\n\r\n\r\nexport class AcArrayDescComponent implements OnChanges, OnInit, AfterContentInit, OnDestroy, IDescription {\r\n\r\n   acFor: string;\r\n\r\n   idGetter: (item: any, index: number) => string;\r\n\r\n   show = true;\r\n   private layer: AcLayerComponent;\r\n   private basicDescs: any;\r\n   private arrayDescs: any;\r\n  private entitiesMap = new Map<string, string[]>();\r\n  private layerServiceSubscription: Subscription;\r\n  private id = 0;\r\n  private readonly acForRgx = /^let\\s+.+\\s+of\\s+.+$/;\r\n  entityName: string;\r\n  arrayPath: string;\r\n  arrayObservable$ = new Subject<AcNotification>();\r\n\r\n  constructor(public layerService: LayerService, private cd: ChangeDetectorRef) {\r\n  }\r\n\r\n  ngOnChanges(changes: SimpleChanges): void {\r\n    if (changes['acFor'].firstChange) {\r\n      const acForString = changes['acFor'].currentValue;\r\n      if (!this.acForRgx.test(acForString)) {\r\n        throw new Error(`ac-layer: Invalid [acFor] syntax. Expected: [acFor]=\"let item of observable\" .Instead received: ${acForString}`);\r\n      }\r\n      const acForArr = changes['acFor'].currentValue.split(' ');\r\n      this.arrayPath = acForArr[3];\r\n      this.entityName = acForArr[1];\r\n    }\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    this.layer.getLayerService().cache = false;\r\n    this.layerServiceSubscription = this.layerService.layerUpdates().subscribe(() => {\r\n      this.cd.detectChanges();\r\n    });\r\n  }\r\n\r\n  ngAfterContentInit(): void {\r\n    this.layerService.context['arrayObservable$'] = this.arrayObservable$;\r\n    this.layerService.registerDescription(this);\r\n    this.basicDescs._results.forEach((component: BasicDesc) => {\r\n      component.setLayerService(this.layer.getLayerService());\r\n    });\r\n    this.arrayDescs._results.splice(0, 1);\r\n    this.arrayDescs._results.forEach((component: AcArrayDescComponent) => {\r\n      this.layerService.unregisterDescription(component);\r\n      this.layer.getLayerService().registerDescription(component);\r\n      component.layerService = this.layer.getLayerService();\r\n      component.setLayerService(this.layer.getLayerService())\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.layerServiceSubscription) {\r\n      this.layerServiceSubscription.unsubscribe();\r\n    }\r\n  }\r\n\r\n  setLayerService(layerService: LayerService) {\r\n    this.layerService = layerService;\r\n  }\r\n\r\n  draw(context: any, id: string, contextEntity: any) {\r\n    const get = _get;\r\n    const entitiesArray: any[] = get(context, this.arrayPath);\r\n    if (!entitiesArray) {\r\n      return;\r\n    }\r\n    const previousEntitiesIdArray = this.entitiesMap.get(id);\r\n    const entitiesIdArray: any[] = [];\r\n    this.entitiesMap.set(id, entitiesIdArray);\r\n\r\n    entitiesArray.forEach((item, index) => {\r\n      this.layerService.context[this.entityName] = item;\r\n      const arrayItemId = this.generateCombinedId(id, item, index);\r\n      entitiesIdArray.push(arrayItemId);\r\n      this.layer.update(contextEntity, arrayItemId);\r\n    });\r\n\r\n    if (previousEntitiesIdArray) {\r\n      const entitiesToRemove = this.idGetter ?\r\n        previousEntitiesIdArray.filter((entityId) => entitiesIdArray.indexOf(entityId) < 0) :\r\n        previousEntitiesIdArray;\r\n      if (entitiesToRemove) {\r\n        entitiesToRemove.forEach((entityId) => this.layer.remove(entityId));\r\n      }\r\n    }\r\n  }\r\n\r\n  remove(id: string) {\r\n    const entitiesIdArray = this.entitiesMap.get(id);\r\n    if (entitiesIdArray) {\r\n      entitiesIdArray.forEach((entityId) => this.layer.remove(entityId));\r\n    }\r\n    this.entitiesMap.delete(id);\r\n  }\r\n\r\n  removeAll() {\r\n    this.layer.removeAll();\r\n    this.entitiesMap.clear();\r\n  }\r\n\r\n  getAcForString() {\r\n    return `let ${this.entityName + '___temp'} of arrayObservable$`;\r\n  }\r\n\r\n  private generateCombinedId(entityId: string, arrayItem: any, index: number): string {\r\n    let arrayItemId;\r\n    if (this.idGetter) {\r\n      arrayItemId = this.idGetter(arrayItem, index);\r\n    }\r\n    else {\r\n      arrayItemId = (this.id++) % Number.MAX_SAFE_INTEGER;\r\n    }\r\n    return entityId + arrayItemId;\r\n  }\r\nstatic decorators: DecoratorInvocation[] = [\n{ type: Component, args: [{\r\n  selector: 'ac-array-desc',\r\n  template: `\r\n      <ac-layer #layer [acFor]=\"getAcForString()\"\r\n                [context]=\"layerService.context\"\r\n                [options]=\"layerService.options\"\r\n                [show]=\"layerService.show && show\"\r\n                [zIndex]=\"layerService.zIndex\">\r\n          <ng-content #content></ng-content>\r\n      </ac-layer>\r\n  `,\r\n}, ] },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: LayerService, },\n{type: ChangeDetectorRef, },\n];\nstatic propDecorators: {[key: string]: DecoratorInvocation[]} = {\n'acFor': [{ type: Input },],\n'idGetter': [{ type: Input },],\n'show': [{ type: Input },],\n'layer': [{ type: ViewChild, args: ['layer', ] },],\n'basicDescs': [{ type: ContentChildren, args: [BasicDesc, { descendants: false }, ] },],\n'arrayDescs': [{ type: ContentChildren, args: [AcArrayDescComponent, { descendants: false }, ] },],\n};\n}\r\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}