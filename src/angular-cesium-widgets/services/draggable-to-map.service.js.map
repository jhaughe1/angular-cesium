{"version":3,"sources":["draggable-to-map.service.ts"],"names":[],"mappings":"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","file":"draggable-to-map.service.js","sourceRoot":"","sourcesContent":["import { Inject, Injectable } from '@angular/core';\r\nimport { DOCUMENT } from '@angular/common';\r\nimport { Vec2 } from '../../angular-cesium/models/vec2';\r\nimport { Cartesian3 } from '../../angular-cesium/models/cartesian3';\r\nimport { Observable } from 'rxjs/Observable';\r\nimport { Subject } from 'rxjs/Subject';\r\nimport { CoordinateConverter } from '../../angular-cesium/services/coordinate-converter/coordinate-converter.service';\r\nimport { MapsManagerService } from '../../angular-cesium/services/maps-manager/maps-manager.service';\r\n\r\nexport interface IconDragEvent {\r\n  initialScreenPosition: Vec2;\r\n  screenPosition: Vec2;\r\n  mapPosition: Cartesian3;\r\n  drop: boolean;\r\n}\r\n\r\n/**\r\n * The Service is used to preform, handle and subscribe to icon dragging when using the `DraggableToMapDirective`.\r\n * For more info check `DraggableToMapDirective` docs.\r\n */\r\n\r\n\r\nexport class DraggableToMapService {\r\n\r\n  private coordinateConverter: CoordinateConverter;\r\n  private dragObservable: Observable<IconDragEvent>;\r\n  private stopper: Subject<any>;\r\n  private mainSubject = new Subject<IconDragEvent>();\r\n\r\n  constructor( private document: any, private mapsManager: MapsManagerService) {\r\n  }\r\n\r\n  setCoordinateConverter(coordinateConverter: CoordinateConverter) {\r\n    this.coordinateConverter = coordinateConverter;\r\n  }\r\n\r\n  drag(imageSrc: string, style?: any) {\r\n    if (!this.coordinateConverter) {\r\n      const map = this.mapsManager.getMap();\r\n      if (map) {\r\n        this.coordinateConverter = map.getCoordinateConverter();\r\n      }\r\n    }\r\n    this.cancel();\r\n    const imgElement = document.createElement('img');\r\n    imgElement.src = imageSrc;\r\n    imgElement.style.position = 'fixed';\r\n    imgElement.style.visibility = 'hidden';\r\n    imgElement.style.width = '30px';\r\n    imgElement.style.height = '30px';\r\n    imgElement.style['user-drag'] = 'none';\r\n    imgElement.style['user-select'] = 'none';\r\n    imgElement.style['-moz-user-select'] = 'none';\r\n    imgElement.style['-webkit-user-drag'] = 'none';\r\n    imgElement.style['-webkit-user-select'] = 'none';\r\n    imgElement.style['-ms-user-select'] = 'none';\r\n    Object.assign(imgElement.style, style);\r\n    document.body.appendChild(imgElement);\r\n\r\n    this.createDragObservable();\r\n    this.dragObservable.subscribe(\r\n      (e) => {\r\n        imgElement.style.visibility = 'visible';\r\n        imgElement.style.left = e.screenPosition.x - imgElement.clientWidth / 2 + 'px';\r\n        imgElement.style.top = e.screenPosition.y - imgElement.clientHeight / 2 + 'px';\r\n        this.mainSubject.next(e);\r\n        if (e.drop) {\r\n          imgElement.remove();\r\n        }\r\n      },\r\n      (e: any) => {\r\n        imgElement.remove();\r\n      },\r\n      () => {\r\n        imgElement.remove();\r\n      }\r\n    );\r\n  }\r\n\r\n  dragUpdates(): Observable<IconDragEvent> {\r\n    return this.mainSubject;\r\n  }\r\n\r\n  cancel() {\r\n    if (this.stopper) {\r\n      this.stopper.next(true);\r\n      this.stopper = undefined;\r\n      this.dragObservable = undefined;\r\n    }\r\n  }\r\n\r\n  private createDragObservable() {\r\n    const stopper = new Subject();\r\n    const dropSubject = new Subject<any>();\r\n    const pointerUp = Observable.fromEvent(document, 'pointerup');\r\n    const pointerMove = Observable.fromEvent(document, 'pointermove');\r\n\r\n    let dragStartPositionX: number;\r\n    let dragStartPositionY: number;\r\n    let lastMove: any;\r\n    const moveObservable = pointerMove.map((e: any) => {\r\n      dragStartPositionX = dragStartPositionX ? dragStartPositionX : e.x;\r\n      dragStartPositionY = dragStartPositionY ? dragStartPositionY : e.y;\r\n      lastMove = {\r\n        drop: false,\r\n        initialScreenPosition: {\r\n          x: dragStartPositionX,\r\n          y: dragStartPositionY,\r\n        },\r\n        screenPosition: {\r\n          x: e.x,\r\n          y: e.y,\r\n        },\r\n        mapPosition: this.coordinateConverter ?\r\n          this.coordinateConverter.screenToCartesian3({ x: e.x, y: e.y }) : undefined,\r\n      };\r\n      return lastMove;\r\n    })\r\n      .takeUntil(pointerUp)\r\n      .do(undefined, undefined, () => {\r\n        if (lastMove) {\r\n          const dropEvent = Object.assign({}, lastMove);\r\n          dropEvent.drop = true;\r\n          dropSubject.next(dropEvent);\r\n        }\r\n      });\r\n\r\n    this.dragObservable = moveObservable.merge(dropSubject).takeUntil(stopper);\r\n    this.stopper = stopper;\r\n  }\r\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: undefined, decorators: [{ type: Inject, args: [DOCUMENT, ] }, ]},\n{type: MapsManagerService, },\n];\n}\r\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}